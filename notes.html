<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Notes Cloud — Netlify</title>
<style>
  /* минимальные стили, адаптируй под свой UI */
  body{font-family:Inter,system-ui,sans-serif;margin:0;background:#071025;color:#e8eef8}
  .container{max-width:1100px;margin:32px auto;padding:16px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .title{font-size:20px;font-weight:700}
  .subjects{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
  .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;width:320px}
  .files{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .file-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px}
  .btn{background:#7c5cff;padding:8px 10px;border-radius:8px;color:white;border:0;cursor:pointer}
  .muted{color:#9fb0d6;font-size:13px}
  /* modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1000}
  .modal-card{background:#0b1220;padding:14px;border-radius:12px;width:90%;max-width:760px;color:#e8eef8}
  .row{margin:10px 0}
  input[type=file]{display:block}
  input[type=text], input[type=password], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  iframe.viewer{width:100%;height:60vh;border:0;border-radius:8px;background:white}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">Notes Cloud (Netlify Blobs)</div>
      <div class="muted">Файлы хранятся в Netlify Blobs. HTML открываются прямо в просмотрщике.</div>
    </div>
    <div>
      <button id="openUpload" class="btn">Загрузить файл</button>
    </div>
  </div>

  <div style="margin-top:18px">
    <input id="search" placeholder="Поиск по имени файла или предмету" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
  </div>

  <div class="subjects" id="subjects"></div>
</div>

<!-- UPLOAD MODAL -->
<div id="uploadModal" class="modal" style="display:none">
  <div class="modal-card">
    <h3>Загрузить файл</h3>
    <div class="row">
      <label>Предмет</label>
      <select id="subjectSelect"></select>
    </div>
    <div class="row">
      <label>Файл</label>
      <input id="fileInput" type="file" />
    </div>
    <div class="row">
      <label>Пароль</label>
      <input id="uploadPass" type="password" placeholder="Пароль" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="uploadCancel" class="btn" style="background:#6b7280">Отмена</button>
      <button id="uploadSend" class="btn">Загрузить</button>
    </div>
    <div id="uploadStatus" class="muted" style="margin-top:8px"></div>
  </div>
</div>

<!-- VIEWER MODAL -->
<div id="viewerModal" class="modal" style="display:none">
  <div class="modal-card" style="max-width:95%;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong id="viewerTitle"></strong><br>
        <span id="viewerSub" class="muted"></span>
      </div>
      <div>
        <button id="viewerClose" class="btn" style="background:#6b7280">Закрыть</button>
      </div>
    </div>
    <div style="margin-top:12px">
      <iframe id="viewerFrame" class="viewer"></iframe>
    </div>
  </div>
</div>

<!-- DELETE PROMPT -->
<div id="deleteModal" class="modal" style="display:none">
  <div class="modal-card">
    <h3>Удалить файл</h3>
    <div class="row">
      <div id="deleteFileName"></div>
      <input id="deletePass" type="password" placeholder="Пароль" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="deleteCancel" class="btn" style="background:#6b7280">Отмена</button>
      <button id="deleteConfirm" class="btn" style="background:#ef4444">Удалить</button>
    </div>
  </div>
</div>

<script>
/* ====== Config ====== */
const SUBJECTS = [
  { id: 'informatics', name: 'Информатика' },
  { id: 'physics', name: 'Физика' },
  { id: 'math', name: 'Математика' },
  { id: 'chemistry', name: 'Химия' }
];

const API = {
  upload: '/.netlify/functions/upload',
  list: '/.netlify/functions/list',
  delete: '/.netlify/functions/delete'
};

/* ====== UI refs ====== */
const subjectsEl = document.getElementById('subjects');
const subjectSelect = document.getElementById('subjectSelect');
const openUploadBtn = document.getElementById('openUpload');
const uploadModal = document.getElementById('uploadModal');
const uploadCancel = document.getElementById('uploadCancel');
const uploadSend = document.getElementById('uploadSend');
const fileInput = document.getElementById('fileInput');
const uploadPass = document.getElementById('uploadPass');
const uploadStatus = document.getElementById('uploadStatus');
const searchInput = document.getElementById('search');

const viewerModal = document.getElementById('viewerModal');
const viewerFrame = document.getElementById('viewerFrame');
const viewerTitle = document.getElementById('viewerTitle');
const viewerSub = document.getElementById('viewerSub');
const viewerClose = document.getElementById('viewerClose');

const deleteModal = document.getElementById('deleteModal');
const deleteFileName = document.getElementById('deleteFileName');
const deletePass = document.getElementById('deletePass');
const deleteConfirm = document.getElementById('deleteConfirm');
const deleteCancel = document.getElementById('deleteCancel');

let allFiles = []; // cached list from server
let selectedToDelete = null;

/* ====== Helpers ====== */
function mkEl(tag, props = {}, children = []) {
  const e = document.createElement(tag);
  Object.assign(e, props);
  children.forEach(c => e.appendChild(c));
  return e;
}

async function fetchList() {
  // get full list
  const res = await fetch(API.list);
  const obj = await res.json();
  if (obj.status !== 'ok') {
    console.error('list error', obj);
    return [];
  }
  return obj.files || [];
}

function renderSubjects(filter = '') {
  subjectsEl.innerHTML = '';
  const q = (filter || '').toLowerCase();

  // group by subject
  const groups = {};
  for(const s of SUBJECTS) groups[s.id] = { name: s.name, files: [] };
  for(const f of allFiles) {
    // f.path like "physics/MKT.html"
    const parts = f.path.split('/');
    const subj = parts.length > 1 ? parts[0] : '';
    if (!groups[subj]) groups[subj] = { name: subj, files: [] };
    // simple search filter
    if(q && !(f.name.toLowerCase().includes(q) || subj.toLowerCase().includes(q))) continue;
    groups[subj].files.push(f);
  }

  for(const sid of Object.keys(groups)) {
    const group = groups[sid];
    const card = mkEl('div', { className: 'card' });
    card.appendChild(mkEl('div', {}, [
      mkEl('div', { innerHTML: `<strong>${group.name}</strong><div class="muted">Файлов: ${group.files.length}</div>` })
    ]));

    const filesWrap = mkEl('div', { className: 'files' });
    group.files.forEach(f => {
      const row = mkEl('div', { className: 'file-row' });
      row.appendChild(mkEl('div', { innerHTML: `<div><strong>${f.name}</strong><div class="muted">${f.path}</div></div>` }));
      const btns = mkEl('div');
      const openBtn = mkEl('button', { className: 'btn', innerText: 'Открыть' });
      openBtn.addEventListener('click', ()=> openViewer(f));
      const delBtn = mkEl('button', { className: 'btn', innerText: 'Удалить', style: 'background:#ef4444;margin-left:8px' });
      delBtn.addEventListener('click', ()=> promptDelete(f));
      btns.appendChild(openBtn);
      btns.appendChild(delBtn);
      row.appendChild(btns);
      filesWrap.appendChild(row);
    });

    card.appendChild(filesWrap);
    subjectsEl.appendChild(card);
  }
}

/* ====== Viewer (embed) ====== */
function openViewer(file) {
  // direct blob URL:
  // /.netlify/blobs/dl/<path>
  const url = `/.netlify/blobs/dl/${encodeURIComponent(file.path)}`;
  viewerFrame.src = url;
  viewerTitle.innerText = file.name;
  viewerSub.innerText = file.path;
  viewerModal.style.display = 'flex';
}

viewerClose.addEventListener('click', ()=> {
  viewerFrame.src = 'about:blank';
  viewerModal.style.display = 'none';
});

/* ====== Delete flow (with password) ====== */
function promptDelete(file) {
  selectedToDelete = file;
  deleteFileName.innerText = `Удалить: ${file.name} (${file.path})`;
  deletePass.value = '';
  deleteModal.style.display = 'flex';
}

deleteCancel.addEventListener('click', ()=> {
  deleteModal.style.display = 'none';
  selectedToDelete = null;
});

deleteConfirm.addEventListener('click', async ()=> {
  const pw = deletePass.value;
  if(!pw) return alert('Введите пароль');
  const res = await fetch(API.delete, {
    method: 'POST',
    body: JSON.stringify({ path: selectedToDelete.path, password: pw }),
    headers: { 'Content-Type': 'application/json' }
  });
  const obj = await res.json();
  if(obj.status === 'deleted') {
    alert('Файл удалён');
    deleteModal.style.display = 'none';
    selectedToDelete = null;
    await loadAndRender();
  } else if(obj.status === 'wrong_password') {
    alert('Неверный пароль');
  } else {
    alert('Ошибка: ' + (obj.message || JSON.stringify(obj)));
  }
});

/* ====== Upload flow ====== */
openUploadBtn.addEventListener('click', () => {
  // fill subject select
  subjectSelect.innerHTML = '';
  SUBJECTS.forEach(s => {
    const o = document.createElement('option');
    o.value = s.id; o.text = s.name;
    subjectSelect.appendChild(o);
  });
  uploadStatus.innerText = '';
  fileInput.value = '';
  uploadPass.value = '';
  uploadModal.style.display = 'flex';
});

uploadCancel.addEventListener('click', ()=> uploadModal.style.display = 'none');

uploadSend.addEventListener('click', async () => {
  const subj = subjectSelect.value;
  const f = fileInput.files[0];
  const pw = uploadPass.value;
  if(!f) return alert('Выберите файл');
  if(!pw) return alert('Введите пароль');

  uploadStatus.innerText = 'Кодируем файл...';
  // read as DataURL
  const dataUrl = await new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = e => rej(e);
    r.readAsDataURL(f);
  });

  uploadStatus.innerText = 'Загружаем на сервер...';

  try {
    const resp = await fetch(API.upload, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        subject: subj,
        filename: f.name,
        dataUrl,
        password: pw
      })
    });
    const obj = await resp.json();
    if(obj.status === 'success') {
      uploadStatus.innerText = 'Готово ✓';
      uploadModal.style.display = 'none';
      await loadAndRender();
      alert('Файл загружен');
    } else if(obj.status === 'wrong_password') {
      alert('Неверный пароль');
    } else {
      alert('Ошибка: ' + (obj.message || JSON.stringify(obj)));
    }
  } catch (err) {
    console.error(err);
    alert('Ошибка загрузки: ' + err.message);
  }
});

/* ====== Load & init ====== */
async function loadAndRender() {
  const files = await fetchList();
  allFiles = files;
  renderSubjects(searchInput.value);
}

// search handler
searchInput.addEventListener('input', ()=> renderSubjects(searchInput.value));

loadAndRender();

</script>
</body>
</html>
